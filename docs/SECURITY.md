# 設定ディレクトリのセキュリティ対策

## 外部アクセスの防止

`config/`ディレクトリは外部からのHTTPリクエストでアクセスできないよう、以下の対策を実施しています。

### 1. Flaskアプリケーション側

- **静的ファイル配信の設定なし**: Flaskアプリケーションには`static_folder`や`send_file`などの静的ファイル配信設定がありません
- **ルーティングの制限**: `/api`エンドポイントのみが公開されており、`/config`へのルーティングは存在しません

### 2. Nginx側の対策

Nginxの設定で以下のアクセスをブロックしています：

```nginx
# セキュリティ: 設定ファイルや機密情報へのアクセスをブロック
location ~ ^/(config|\.env|\.git) {
    deny all;
    return 404;
}

# セキュリティ: 設定ファイル形式への直接アクセスをブロック
location ~ \.(yaml|yml|env|ini|conf)$ {
    deny all;
    return 404;
}
```

**ブロックされるパス**:
- `/config/*` - 設定ディレクトリ全体
- `/.env*` - 環境変数ファイル
- `/.git/*` - Gitリポジトリ
- `*.yaml`, `*.yml` - YAML設定ファイル
- `*.env` - 環境変数ファイル
- `*.ini`, `*.conf` - 設定ファイル

### 3. ディレクトリ構造による保護

- `config/`ディレクトリはアプリケーションコード内に配置
- Webサーバーのドキュメントルート外に配置
- 直接URLでアクセスできない構造

## 確認方法

以下のコマンドで設定ファイルへのアクセスがブロックされていることを確認できます：

```bash
# 404エラーが返されることを確認
curl -I http://localhost:8000/config/config.yaml
# または
curl http://localhost:8000/config/config.yaml
```

## 追加のセキュリティ対策

1. **`.gitignore`で除外**: `config/config.yaml` はGitにコミットされません。
2. **Secrets API による管理**: データベースパスワードなどの機密情報は、専用の `art-gallery-secrets-api` から取得します。
3. **ワンタイムトークン認証**: APIからの取得には、起動時に一度だけ有効なワンタイムトークンを使用し、使用後はトークンファイルを破棄します。
4. **プロセスの自動終了**: `secrets-api` は役割を終えると自動的に終了し、機密情報へのアクセス経路を最小化します。

## まとめ

- ✅ Flaskアプリケーション側で静的ファイル配信なし
- ✅ Nginx側で`/config`へのアクセスをブロック
- ✅ 設定ファイル形式（`.yaml`, `.yml`など）への直接アクセスをブロック
- ✅ `.gitignore`で設定ファイルを除外

これにより、`config/`ディレクトリは外部からのHTTPリクエストでアクセスできません。

